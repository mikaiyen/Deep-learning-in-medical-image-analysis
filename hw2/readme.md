
---

# Homework 2: SPECT 影像之多分類預測 (PD 病程分期)

本作業目標為分析單光子放射斷層掃描 (SPECT) 影像中帕金森氏症 (Parkinson’s Disease, PD) 的病程分期。每個病患依據疾病嚴重程度分為三個階段 (Stage 1, 2, 3)，需利用影像以及年齡、性別等輔助資訊來預測病患屬於哪個階段。

## 1. 專案簡介

- **資料來源與格式**  
  - 來源：**hwk02_data.zip** (包含 `train.csv` 和 `test.csv`)。  
  - 每筆資料代表一位病患的 SPECT 影像 (擁有多個切片，屬於 3D 影像)，同時包含病患年齡與性別等欄位。  
  - `train.csv`：含有病患 ID、疾病階段 (Stage 1/2/3)、建議使用的切片索引 (index)、年齡、性別，以及其他合併資訊。  
  - `test.csv`：用於最終預測及模型評估，不包含真實階段標籤，但結構類似 `train.csv`。  

- **任務目標**  
  透過神經網路 (CNN / Transformer) 與遷移學習 (Transfer Learning)，對單張或多張切片進行分析，並預測病患的 PD 病程分期 (multi-class classification)。

## 2. 環境與需求

- **程式語言**：Python 3.x  
- **主要套件/函式庫**  
  - PyTorch (建構與訓練神經網路)  
  - NumPy / pandas (資料處理)  
  - OpenCV / PIL / pydicom (影像處理，可視程式需求)  
  - Matplotlib (繪圖)  
- **硬體需求**：建議搭配 GPU (CUDA) 以加速深度學習訓練。

## 3. 資料前處理

1. **切片選擇**  
   - 由於每個病患的 SPECT 影像為 3D (包含多張 2D slice)，可根據作業指示或 `train.csv` / `test.csv` 中的 `index` 欄位，選取包含最清晰紋理的切片作為後續分析對象。
   - 或者自行於 3D 堆疊影像中挑選腦部結構最明顯的切片。

2. **影像裁切 (Crop)**  
   - 原始 SPECT 影像部分區域僅包含黑色背景，因此建議只保留中間的 50×50 像素範圍 (確保腦部結構完整)。  
   - 此裁切降低不必要的背景雜訊，也減少後續模型參數負擔。

3. **三通道建構**  
   - 因為使用預訓練模型 (如 VGG、ResNet、ViT、Swin Transformer)，通常需三通道 (RGB) 輸入。  
   - 若原始影像為灰階，可考慮以下方式：
     1. **重複同一張灰階切片於三個通道** (最簡單)  
     2. **使用相鄰三張 slice** (index-1, index, index+1) 組成三通道  
     3. **其他自訂方法** 例如同張影像經不同增強 (augmentation) 或不同處理後，組成三通道。

## 4. 數據整合：結合性別與年齡

- **使用方式**  
  - 讀取 `train.csv` 中的 `Age` (年齡) 與 `Gender` (性別) 欄位，將其轉化為數值 (如性別 0/1)。  
  - 與影像特徵 (CNN/Transformer 輸出) 拼接 (例如 `torch.cat`)，作為最終全連接層 (Fully-Connected Layer) 的輸入。

## 5. 模型與訓練設定

1. **模型架構**  
   - 作業要求至少嘗試下列三種預訓練模型或架構：  
     1. **VGGNet** (如 `VGG16` 或 `VGG19`)  
     2. **ResNet** (如 `ResNet50`)  
     3. **Vision Transformer (ViT)** (或其他 Transformer-based 模型，如 Swin Transformer)  
   - 以 **VGG** 模型為例：  
     - 輸入層(三通道) → 多層卷積 + max pooling → 全連接層 → 輸出層(3 類)  
     - **Parameters**: 依照最終模型調整，報告中提到約有 14,847,299 個參數。

2. **超參數**  
   - 損失函數：CrossEntropyLoss (因為是多分類問題)  
   - 學習率 (learning rate)：如 1e-4 或 1e-5 (依前處理與遷移學習調整)  
   - 批次大小 (batch size)：依 GPU 記憶體考量，一般可設為 16 或 32  
   - Epoch 數：可以先嘗試 10～20，視收斂速度與性能調整  
   - 優化器 (Optimizer)：Adam / SGD  

3. **遷移學習 (Transfer Learning)**  
   - 使用 ImageNet 預訓練權重進行微調 (fine-tuning) 或特徵提取 (feature extraction)。  
   - 需特別留意輸入影像大小與通道數符合預訓練模型需求 (如 224×224×3)。

4. **再現性**  
   - 設置亂數種子 (e.g., `torch.manual_seed(42)`) 可在一定程度上穩定結果。  
   - GPU 訓練過程仍可能存在微小浮點數誤差，因而結果會略有差異。

## 6. 執行與使用方式

1. **程式執行步驟**  
   - 在 Jupyter Notebook (如 `313554058.ipynb`) 中可分段執行、可視化各階段流程。

2. **輸出結果**  
   - 讀取 `test.csv`，完成推論後將預測 (Stage 1/2/3) 輸出成指定格式做評估。

## 7. 訓練與結果

1. **參數量**  
   - 依據最終使用的模型，可能約 **14,847,299** (以 VGG 為例)。  
   - 可利用 `sum(p.numel() for p in model.parameters())` 取得。

2. **訓練難點**  
   - **理解並改動預訓練模型** 結構有時容易「改壞」；需充分掌握網路層定義、維度變化。  
   - **處理 3D 影像** 轉換成 2D slice，多通道合併時的邏輯與維度對齊問題也需謹慎。

## 8. 結論與未來展望

- **本次作業成果**  
  - 建構深度學習多分類模型，預測 PD 三種病程分期。  
  - 融合年齡、性別資訊能在一定程度上提高準確度。  
  - 透過遷移學習較快收斂並獲得不錯的推論效果。

- **未來可能延伸**  
  - 多張 slice 結合 3D 卷積或序列模型 (e.g., RNN, LSTM) 分析整個立體資訊。  
  - 進一步資料增強 (Data Augmentation)，減少過擬合。  
  - 尋找更適合醫學影像的 Transformer 模型結構或加強預處理方法。
